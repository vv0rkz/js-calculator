#!/usr/bin/env node
import { readFileSync, writeFileSync, existsSync } from "fs"
import { execSync } from "child_process"

console.log("üé® –û–±–Ω–æ–≤–ª—è—é README —Ä–µ–ª–∏–∑–∞–º–∏ —Å –¥–µ–º–æ...")

const changelog = readFileSync("CHANGELOG.md", "utf8")
let readme = readFileSync("README.md", "utf8")

// –ü–∞—Ä—Å–∏–º changelog - –¢–û–õ–¨–ö–û –≤–µ—Ä—Å–∏–∏ —Å –¥–µ–º–æ
const versionBlocks = changelog.split("## v").slice(1)
let prettyChangelog = "## üìã –ò—Å—Ç–æ—Ä–∏—è –≤–µ—Ä—Å–∏–π\n\n"
const processedVersions = new Set()

versionBlocks.forEach((versionBlock) => {
    const versionMatch = versionBlock.match(/^(\d+\.\d+\.\d+)/)
    if (!versionMatch) return

    const version = `v${versionMatch[1]}`
    if (processedVersions.has(version)) return
    processedVersions.add(version)

    // –ü–†–û–í–ï–†–Ø–ï–ú –î–ï–ú–û - –µ—Å–ª–∏ –Ω–µ—Ç –¥–µ–º–æ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
    const hasDemo = existsSync(`docs/${version}.gif`) || existsSync(`docs/${version}.png`)
    if (!hasDemo) {
        console.log(`‚è≠Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞–µ–º ${version} - –Ω–µ—Ç –¥–µ–º–æ`)
        return
    }

    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ –Ω–µ—Ç —Ñ–∏—á
    if (!versionBlock.includes("### ‚ú® –§–∏—á–∏")) {
        console.log(`‚è≠Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞–µ–º ${version} - –Ω–µ—Ç —Ñ–∏—á`)
        return
    }

    // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ñ–∏—á–∏
    const features = []
    const lines = versionBlock.split("\n")
    let inFeaturesSection = false

    for (const line of lines) {
        if (line.includes("### ‚ú® –§–∏—á–∏")) {
            inFeaturesSection = true
            continue
        }
        if (inFeaturesSection && line.includes("### ")) break
        if (inFeaturesSection && line.trim().startsWith("-") && features.length < 3) {
            const cleanFeature = line
                .replace(/^- /, "")
                .replace(/\(\[#\d+\]\([^)]+\)\)/g, "")
                .replace(/\[#\d+\]\([^)]+\)/g, "")
                .replace(/#\d+\s*/, "")
                .replace(/\[[^\]]+\]\([^)]+\)/g, "")
                .trim()

            if (cleanFeature && !cleanFeature.toLowerCase().includes("—Ç–µ—Å—Ç") && cleanFeature.length > 10) {
                features.push(cleanFeature)
            }
        }
    }

    if (features.length === 0) return

    console.log(`‚úÖ –î–æ–±–∞–≤–ª—è–µ–º ${version} - –µ—Å—Ç—å –¥–µ–º–æ –∏ ${features.length} —Ñ–∏—á`)

    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤–µ—Ä—Å–∏—é
    prettyChangelog += `### üü¢ ${version}\n\n`

    // –î–æ–±–∞–≤–ª—è–µ–º –¥–µ–º–æ (–≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –µ—Å—Ç—å)
    if (existsSync(`docs/${version}.gif`)) {
        prettyChangelog += `**–î–µ–º–æ —Ä–∞–±–æ—Ç—ã**  \n<img src="docs/${version}.gif" width="400" />\n\n`
    } else {
        prettyChangelog += `**–î–µ–º–æ —Ä–∞–±–æ—Ç—ã**  \n<img src="docs/${version}.png" width="400" />\n\n`
    }

    // –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
    prettyChangelog += `**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**\n`
    features.forEach((feature) => {
        prettyChangelog += `- ${feature}\n`
    })

    prettyChangelog += `\n**–†–µ–ª–∏–∑:** https://github.com/ione-chebkn/js-calculator/releases/tag/${version}\n\n---\n\n`
})

// –ó–∞–º–µ–Ω—è–µ–º —Å–µ–∫—Ü–∏—é –º–µ–∂–¥—É –º–∞—Ä–∫–µ—Ä–∞–º–∏
if (readme.includes("<!-- AUTOGENERATED_SECTION START -->")) {
    const startMarker = "<!-- AUTOGENERATED_SECTION START -->"
    const endMarker = "<!-- AUTOGENERATED_SECTION END -->"

    const startIndex = readme.indexOf(startMarker)
    const endIndex = readme.indexOf(endMarker, startIndex + startMarker.length)

    if (startIndex !== -1 && endIndex !== -1) {
        readme =
            readme.substring(0, startIndex + startMarker.length) + "\n" + prettyChangelog + readme.substring(endIndex)
        console.log("‚úÖ –°–µ–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞")
    }
} else {
    console.log("‚ùå –ú–∞—Ä–∫–µ—Ä <!-- AUTOGENERATED_SECTION START --> –Ω–µ –Ω–∞–π–¥–µ–Ω")
    process.exit(1)
}

// –°–æ—Ö—Ä–∞–Ω—è–µ–º
writeFileSync("README.md", readme)
console.log("‚úÖ README –æ–±–Ω–æ–≤–ª—ë–Ω —Å —Ä–µ–ª–∏–∑–∞–º–∏, —É –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å –¥–µ–º–æ!")
try {
    execSync("git add README.md", { stdio: "inherit" })
    execSync('git commit -m "docs: update README with demo releases"', { stdio: "inherit" })
    execSync("git push", { stdio: "inherit" })
    console.log("üöÄ –ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–ø—É—â–µ–Ω—ã!")
} catch (error) {
    console.log("üí° README –æ–±–Ω–æ–≤–ª—ë–Ω –ª–æ–∫–∞–ª—å–Ω–æ")
}
