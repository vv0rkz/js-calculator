name: Update README with Changelog

on:
    release:
        types: [published]

jobs:
    update-readme:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "18"

            - name: Install dependencies
              run: npm ci

            - name: Check for demo file
              run: |
                  LATEST_TAG=$(git describe --tags --abbrev=0)
                  echo "Latest tag: $LATEST_TAG"

                  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –¥–µ–º–æ –¥–ª—è —ç—Ç–æ–≥–æ —Ä–µ–ª–∏–∑–∞
                  if [ ! -f "docs/$LATEST_TAG.gif" ] && [ ! -f "docs/$LATEST_TAG.png" ]; then
                    echo "‚ùå –ù–µ—Ç –¥–µ–º–æ —Ñ–∞–π–ª–∞ –¥–ª—è —Ä–µ–ª–∏–∑–∞ $LATEST_TAG"
                    echo "üì∏ –°–æ–∑–¥–∞–π—Ç–µ: docs/$LATEST_TAG.gif –∏–ª–∏ docs/$LATEST_TAG.png"
                    exit 1
                  fi
                  echo "‚úÖ –î–µ–º–æ —Ñ–∞–π–ª –Ω–∞–π–¥–µ–Ω –¥–ª—è $LATEST_TAG"

            - name: Update README with changelog
              run: |
                  # –í—Å—Ç–∞–≤–ª—è–µ–º CHANGELOG.md –≤ README –ø–æ—Å–ª–µ –º–∞—Ä–∫–µ—Ä–∞
                  awk '
                    /<!-- CHANGELOG_PLACEHOLDER -->/ {
                      print
                      while((getline line < "CHANGELOG.md") > 0) {
                        print line
                      }
                      close("CHANGELOG.md")
                      next
                    }
                    { print }
                  ' README.md > README_temp.md

                  mv README_temp.md README.md
                  echo "‚úÖ README –æ–±–Ω–æ–≤–ª—ë–Ω"

            - name: Commit and push changes
              run: |
                  git config user.name "github-actions"
                  git config user.email "github-actions@github.com"
                  git add README.md
                  git commit -m "docs: update README with ${{ github.event.release.tag_name }} changelog"
                  git push
